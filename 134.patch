From bd8e72e7bb7f1a80bc79ab82c784b2197cdc3530 Mon Sep 17 00:00:00 2001
From: Limour <93720049+Limour-dev@users.noreply.github.com>
Date: Sun, 26 Mar 2023 10:21:35 +0800
Subject: [PATCH] set a system role as a persistent role

https://github.com/ztjhz/BetterChatGPT/issues/130
---
 src/utils/messageUtils.ts | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/src/utils/messageUtils.ts b/src/utils/messageUtils.ts
index afccf4bf..36b59a2c 100644
--- a/src/utils/messageUtils.ts
+++ b/src/utils/messageUtils.ts
@@ -49,6 +49,11 @@ export const limitMessageTokens = (
   const limitedMessages: MessageInterface[] = [];
   let tokenCount = 0;
 
+  if (messages[0]?.role === 'system') {
+    const count = countTokens([messages[0]], model);
+    tokenCount += count;
+  }
+
   for (let i = messages.length - 1; i >= 0; i--) {
     const count = countTokens([messages[i]], model);
     if (count + tokenCount > limit) break;
@@ -56,6 +61,17 @@ export const limitMessageTokens = (
     limitedMessages.unshift({ ...messages[i] });
   }
 
+  if (messages[0]?.role === 'system' && limitedMessages[0]?.role !== 'system') {
+    limitedMessages.unshift({ ...messages[0] });
+  }
+
+  if (limitedMessages.length > 4 && limitedMessages[0].role === 'system'){
+    const firstElement = limitedMessages.shift(); // 取出第一个元素并移除
+    if (firstElement !== undefined) { // 确保 firstElement 不为 undefined
+      limitedMessages.splice(-3, 0, firstElement); // 将第一个元素插入到倒数第四个位置
+    }
+  }
+
   return limitedMessages;
 };
 
